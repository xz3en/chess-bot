import { Message } from '../structures/message.ts';
import { User } from '../structures/user.ts';
import { CHANNEL_MESSAGE } from '../types/endpoint.ts';
import { Snowflake } from '../utils/snowflake.ts';
import { BaseManager } from './base.ts';
export class MessagesManager extends BaseManager {
    channel;
    constructor(client, channel){
        super(client, `messages:${channel.id}`, Message);
        this.channel = channel;
    }
    async get(key) {
        const raw = await this._get(key);
        if (raw === undefined) return;
        if (raw.author === undefined) return;
        let channel = await this.client.channels.get(raw.channel_id);
        if (channel === undefined) channel = await this.client.channels.fetch(raw.channel_id);
        let author = await this.client.users.get(raw.author.id);
        if (author === undefined) author = new User(this.client, raw.author);
        const res = new this.DataType(this.client, raw, channel, author);
        await res.mentions.fromPayload(raw);
        if (typeof raw.guild_id === 'string') res.guild = await this.client.guilds.get(raw.guild_id);
        if (typeof res.guild === 'object') res.member = await res.guild.members.get(raw.author.id);
        return res;
    }
    async set(key, value) {
        await this.client.cache.set(this.cacheName, key, value, this.client.messageCacheLifetime);
        const keys = await this.client.cache.keys(this.cacheName) ?? [];
        if (keys.length > this.client.messageCacheMax) {
            const sorted = keys.sort((b, a)=>new Snowflake(a).timestamp - new Snowflake(b).timestamp);
            const toRemove = sorted.filter((_, i)=>i >= this.client.messageCacheMax);
            await this.client.cache.delete(this.cacheName, ...toRemove);
        }
    }
    async array() {
        let arr = await this.client.cache.array(this.cacheName);
        if (arr === undefined) arr = [];
        const result = [];
        await Promise.all(arr.map(async (raw)=>{
            if (raw.author === undefined) return;
            let channel = await this.client.channels.get(raw.channel_id);
            if (channel === undefined) channel = await this.client.channels.fetch(raw.channel_id);
            if (channel === undefined) return;
            let author = await this.client.users.get(raw.author.id);
            if (author === undefined) author = new User(this.client, raw.author);
            const res = new Message(this.client, raw, // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion
            channel, author);
            await res.mentions.fromPayload(raw);
            result.push(res);
        }));
        return result;
    }
    async fetch(id) {
        return await new Promise((resolve, reject)=>{
            this.client.rest.get(CHANNEL_MESSAGE(this.channel.id, id)).then(async (data)=>{
                await this.set(id, data);
                let channel = await this.client.channels.get(this.channel.id);
                if (channel === undefined) channel = await this.client.channels.fetch(this.channel.id);
                await this.client.users.set(data.author.id, data.author);
                const res = await this.get(data.id);
                await res.mentions.fromPayload(data);
                resolve(res);
            }).catch((e)=>reject(e));
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvaGFybW9ueUB2Mi45LjAvc3JjL21hbmFnZXJzL21lc3NhZ2VzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ2xpZW50IH0gZnJvbSAnLi4vY2xpZW50L21vZC50cydcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tICcuLi9zdHJ1Y3R1cmVzL21lc3NhZ2UudHMnXG5pbXBvcnQgdHlwZSB7IFRleHRDaGFubmVsIH0gZnJvbSAnLi4vc3RydWN0dXJlcy90ZXh0Q2hhbm5lbC50cydcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9zdHJ1Y3R1cmVzL3VzZXIudHMnXG5pbXBvcnQgdHlwZSB7IE1lc3NhZ2VQYXlsb2FkIH0gZnJvbSAnLi4vdHlwZXMvY2hhbm5lbC50cydcbmltcG9ydCB7IENIQU5ORUxfTUVTU0FHRSB9IGZyb20gJy4uL3R5cGVzL2VuZHBvaW50LnRzJ1xuaW1wb3J0IHsgU25vd2ZsYWtlIH0gZnJvbSAnLi4vdXRpbHMvc25vd2ZsYWtlLnRzJ1xuaW1wb3J0IHsgQmFzZU1hbmFnZXIgfSBmcm9tICcuL2Jhc2UudHMnXG5cbmV4cG9ydCBjbGFzcyBNZXNzYWdlc01hbmFnZXIgZXh0ZW5kcyBCYXNlTWFuYWdlcjxNZXNzYWdlUGF5bG9hZCwgTWVzc2FnZT4ge1xuICBjaGFubmVsOiBUZXh0Q2hhbm5lbFxuXG4gIGNvbnN0cnVjdG9yKGNsaWVudDogQ2xpZW50LCBjaGFubmVsOiBUZXh0Q2hhbm5lbCkge1xuICAgIHN1cGVyKGNsaWVudCwgYG1lc3NhZ2VzOiR7Y2hhbm5lbC5pZH1gLCBNZXNzYWdlKVxuICAgIHRoaXMuY2hhbm5lbCA9IGNoYW5uZWxcbiAgfVxuXG4gIGFzeW5jIGdldChrZXk6IHN0cmluZyk6IFByb21pc2U8TWVzc2FnZSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHJhdyA9IGF3YWl0IHRoaXMuX2dldChrZXkpXG4gICAgaWYgKHJhdyA9PT0gdW5kZWZpbmVkKSByZXR1cm5cblxuICAgIGlmIChyYXcuYXV0aG9yID09PSB1bmRlZmluZWQpIHJldHVyblxuXG4gICAgbGV0IGNoYW5uZWwgPSBhd2FpdCB0aGlzLmNsaWVudC5jaGFubmVscy5nZXQocmF3LmNoYW5uZWxfaWQpXG4gICAgaWYgKGNoYW5uZWwgPT09IHVuZGVmaW5lZClcbiAgICAgIGNoYW5uZWwgPSBhd2FpdCB0aGlzLmNsaWVudC5jaGFubmVscy5mZXRjaChyYXcuY2hhbm5lbF9pZClcblxuICAgIGxldCBhdXRob3IgPSAoYXdhaXQgdGhpcy5jbGllbnQudXNlcnMuZ2V0KHJhdy5hdXRob3IuaWQpKSBhcyB1bmtub3duIGFzIFVzZXJcblxuICAgIGlmIChhdXRob3IgPT09IHVuZGVmaW5lZCkgYXV0aG9yID0gbmV3IFVzZXIodGhpcy5jbGllbnQsIHJhdy5hdXRob3IpXG5cbiAgICBjb25zdCByZXMgPSBuZXcgdGhpcy5EYXRhVHlwZSh0aGlzLmNsaWVudCwgcmF3LCBjaGFubmVsLCBhdXRob3IpXG4gICAgYXdhaXQgcmVzLm1lbnRpb25zLmZyb21QYXlsb2FkKHJhdylcblxuICAgIGlmICh0eXBlb2YgcmF3Lmd1aWxkX2lkID09PSAnc3RyaW5nJylcbiAgICAgIHJlcy5ndWlsZCA9IGF3YWl0IHRoaXMuY2xpZW50Lmd1aWxkcy5nZXQocmF3Lmd1aWxkX2lkKVxuXG4gICAgaWYgKHR5cGVvZiByZXMuZ3VpbGQgPT09ICdvYmplY3QnKVxuICAgICAgcmVzLm1lbWJlciA9IGF3YWl0IHJlcy5ndWlsZC5tZW1iZXJzLmdldChyYXcuYXV0aG9yLmlkKVxuXG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgYXN5bmMgc2V0KGtleTogc3RyaW5nLCB2YWx1ZTogTWVzc2FnZVBheWxvYWQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5jYWNoZS5zZXQoXG4gICAgICB0aGlzLmNhY2hlTmFtZSxcbiAgICAgIGtleSxcbiAgICAgIHZhbHVlLFxuICAgICAgdGhpcy5jbGllbnQubWVzc2FnZUNhY2hlTGlmZXRpbWVcbiAgICApXG4gICAgY29uc3Qga2V5cyA9IChhd2FpdCB0aGlzLmNsaWVudC5jYWNoZS5rZXlzKHRoaXMuY2FjaGVOYW1lKSkgPz8gW11cbiAgICBpZiAoa2V5cy5sZW5ndGggPiB0aGlzLmNsaWVudC5tZXNzYWdlQ2FjaGVNYXgpIHtcbiAgICAgIGNvbnN0IHNvcnRlZCA9IGtleXMuc29ydChcbiAgICAgICAgKGIsIGEpID0+IG5ldyBTbm93Zmxha2UoYSkudGltZXN0YW1wIC0gbmV3IFNub3dmbGFrZShiKS50aW1lc3RhbXBcbiAgICAgIClcbiAgICAgIGNvbnN0IHRvUmVtb3ZlID0gc29ydGVkLmZpbHRlcigoXywgaSkgPT4gaSA+PSB0aGlzLmNsaWVudC5tZXNzYWdlQ2FjaGVNYXgpXG4gICAgICBhd2FpdCB0aGlzLmNsaWVudC5jYWNoZS5kZWxldGUodGhpcy5jYWNoZU5hbWUsIC4uLnRvUmVtb3ZlKVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGFycmF5KCk6IFByb21pc2U8TWVzc2FnZVtdPiB7XG4gICAgbGV0IGFyciA9IGF3YWl0ICh0aGlzLmNsaWVudC5jYWNoZS5hcnJheShcbiAgICAgIHRoaXMuY2FjaGVOYW1lXG4gICAgKSBhcyBNZXNzYWdlUGF5bG9hZFtdKVxuICAgIGlmIChhcnIgPT09IHVuZGVmaW5lZCkgYXJyID0gW11cblxuICAgIGNvbnN0IHJlc3VsdDogTWVzc2FnZVtdID0gW11cbiAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGFyci5tYXAoYXN5bmMgKHJhdykgPT4ge1xuICAgICAgICBpZiAocmF3LmF1dGhvciA9PT0gdW5kZWZpbmVkKSByZXR1cm5cblxuICAgICAgICBsZXQgY2hhbm5lbCA9IGF3YWl0IHRoaXMuY2xpZW50LmNoYW5uZWxzLmdldChyYXcuY2hhbm5lbF9pZClcbiAgICAgICAgaWYgKGNoYW5uZWwgPT09IHVuZGVmaW5lZClcbiAgICAgICAgICBjaGFubmVsID0gYXdhaXQgdGhpcy5jbGllbnQuY2hhbm5lbHMuZmV0Y2gocmF3LmNoYW5uZWxfaWQpXG4gICAgICAgIGlmIChjaGFubmVsID09PSB1bmRlZmluZWQpIHJldHVyblxuXG4gICAgICAgIGxldCBhdXRob3IgPSAoYXdhaXQgdGhpcy5jbGllbnQudXNlcnMuZ2V0KFxuICAgICAgICAgIHJhdy5hdXRob3IuaWRcbiAgICAgICAgKSkgYXMgdW5rbm93biBhcyBVc2VyXG5cbiAgICAgICAgaWYgKGF1dGhvciA9PT0gdW5kZWZpbmVkKSBhdXRob3IgPSBuZXcgVXNlcih0aGlzLmNsaWVudCwgcmF3LmF1dGhvcilcblxuICAgICAgICBjb25zdCByZXMgPSBuZXcgTWVzc2FnZShcbiAgICAgICAgICB0aGlzLmNsaWVudCxcbiAgICAgICAgICByYXcsXG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bm5lY2Vzc2FyeS10eXBlLWFzc2VydGlvblxuICAgICAgICAgIGNoYW5uZWwgYXMgVGV4dENoYW5uZWwsXG4gICAgICAgICAgYXV0aG9yXG4gICAgICAgIClcbiAgICAgICAgYXdhaXQgcmVzLm1lbnRpb25zLmZyb21QYXlsb2FkKHJhdylcbiAgICAgICAgcmVzdWx0LnB1c2gocmVzKVxuICAgICAgfSlcbiAgICApXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgYXN5bmMgZmV0Y2goaWQ6IHN0cmluZyk6IFByb21pc2U8TWVzc2FnZT4ge1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5yZXN0XG4gICAgICAgIC5nZXQoQ0hBTk5FTF9NRVNTQUdFKHRoaXMuY2hhbm5lbC5pZCwgaWQpKVxuICAgICAgICAudGhlbihhc3luYyAoZGF0YSkgPT4ge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc2V0KGlkLCBkYXRhIGFzIE1lc3NhZ2VQYXlsb2FkKVxuXG4gICAgICAgICAgbGV0IGNoYW5uZWwgPSBhd2FpdCB0aGlzLmNsaWVudC5jaGFubmVscy5nZXQ8VGV4dENoYW5uZWw+KFxuICAgICAgICAgICAgdGhpcy5jaGFubmVsLmlkXG4gICAgICAgICAgKVxuICAgICAgICAgIGlmIChjaGFubmVsID09PSB1bmRlZmluZWQpXG4gICAgICAgICAgICBjaGFubmVsID0gYXdhaXQgdGhpcy5jbGllbnQuY2hhbm5lbHMuZmV0Y2godGhpcy5jaGFubmVsLmlkKVxuXG4gICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQudXNlcnMuc2V0KFxuICAgICAgICAgICAgZGF0YS5hdXRob3IuaWQsXG4gICAgICAgICAgICAoZGF0YSBhcyBNZXNzYWdlUGF5bG9hZCkuYXV0aG9yXG4gICAgICAgICAgKVxuXG4gICAgICAgICAgY29uc3QgcmVzID0gKGF3YWl0IHRoaXMuZ2V0KGRhdGEuaWQpKSBhcyBNZXNzYWdlXG5cbiAgICAgICAgICBhd2FpdCByZXMubWVudGlvbnMuZnJvbVBheWxvYWQoZGF0YSlcblxuICAgICAgICAgIHJlc29sdmUocmVzKVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGUpID0+IHJlamVjdChlKSlcbiAgICB9KVxuICB9XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsU0FBUyxPQUFPLFFBQVEsMkJBQTBCO0FBRWxELFNBQVMsSUFBSSxRQUFRLHdCQUF1QjtBQUU1QyxTQUFTLGVBQWUsUUFBUSx1QkFBc0I7QUFDdEQsU0FBUyxTQUFTLFFBQVEsd0JBQXVCO0FBQ2pELFNBQVMsV0FBVyxRQUFRLFlBQVc7QUFFdkMsT0FBTyxNQUFNLHdCQUF3QjtJQUNuQyxRQUFvQjtJQUVwQixZQUFZLE1BQWMsRUFBRSxPQUFvQixDQUFFO1FBQ2hELEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsRUFBRTtRQUN4QyxJQUFJLENBQUMsT0FBTyxHQUFHO0lBQ2pCO0lBRUEsTUFBTSxJQUFJLEdBQVcsRUFBZ0M7UUFDbkQsTUFBTSxNQUFNLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQztRQUM1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