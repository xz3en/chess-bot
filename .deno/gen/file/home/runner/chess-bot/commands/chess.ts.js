import { Harmony, Canvas } from "../deps.ts";
import CCommand from "../classes/customCommand.ts";
// Classes
class Square {
    piece;
    constructor(x, y, position, color){
        this.x = x;
        this.y = y;
        this.position = position;
        this.color = color;
    }
    x;
    y;
    position;
    color;
}
class Board {
    canvas;
    context;
    constructor(size){
        this.size = size;
        this.canvas = Canvas.createCanvas(size, size);
        this.context = this.canvas.getContext("2d");
    }
    size;
}
export class Game {
    board = new Map;
    canvas;
    constructor(){
        this.canvas = new Board(600);
    }
    updateSquare(position, piece) {
        const square = this.board.get(position);
        if (!square) return;
        square.piece = piece;
    }
    move(oldPosition, newPosition) {
        const square1 = this.board.get(oldPosition);
        const square2 = this.board.get(newPosition);
        if (!square1 || !square2) return false;
        if (!square1.piece) return false;
        if (square2.piece && square1.piece.color === square2.piece.color) return false;
        square2.piece = square1.piece;
        square1.piece = undefined;
        this.board.set(oldPosition, square1);
        this.board.set(newPosition, square2);
        return true;
    }
    async updateBoard() {
        for (const [_position, square] of this.board.entries()){
            if (!square.piece) continue;
            const imagePath = `assets/pieces/${square.piece.color}/${square.piece.type}.png`;
            try {
                const image = await Canvas.loadImage(imagePath);
                this.canvas.context.drawImage(image, square.x, square.y, this.board.size + 10, this.board.size + 10);
            } catch (err) {
                console.log(err);
            }
        }
    }
}
// Variables
const messageComponents = [
    {
        type: Harmony.MessageComponentType.ACTION_ROW,
        components: [
            {
                type: Harmony.MessageComponentType.BUTTON,
                style: Harmony.ButtonStyle.BLURPLE,
                label: "Make a move",
                customID: "makeMove"
            }
        ]
    }
];
const primaryColor = "#eeeed5"; // White
const secondaryColor = "#7c955b"; // Green
const fileLetters = "abcdefgh";
const games = new Map;
// Functions
async function createGame(id) {
    if (games.get(id)) return;
    const game = new Game();
    const squareSize = game.canvas.size / 8;
    for(let x = 0; x < 8; x++){
        const fileLetter = fileLetters.at(x);
        for(let y = 0; y < 8; y++){
            const squarePosition = `${fileLetter}${8 - y}`;
            game.canvas.context.fillStyle = (x + y) % 2 == 0 ? primaryColor : secondaryColor;
            const xOffset = x * squareSize;
            const yOffset = y * squareSize;
            game.canvas.context.fillRect(xOffset, yOffset, squareSize, squareSize);
            const square = new Square(xOffset, yOffset, squarePosition, (x + y) % 2 == 0 ? "white" : "black");
            game.board.set(squarePosition, square);
        }
    }
    // Create white pieces
    game.updateSquare("a1", {
        type: "rook",
        color: "white"
    });
    game.updateSquare("b1", {
        type: "knight",
        color: "white"
    });
    game.updateSquare("c1", {
        type: "bishop",
        color: "white"
    });
    game.updateSquare("d1", {
        type: "king",
        color: "white"
    });
    game.updateSquare("e1", {
        type: "queen",
        color: "white"
    });
    game.updateSquare("f1", {
        type: "bishop",
        color: "white"
    });
    game.updateSquare("g1", {
        type: "knight",
        color: "white"
    });
    game.updateSquare("h1", {
        type: "rook",
        color: "white"
    });
    // Create black pieces
    game.updateSquare("a8", {
        type: "rook",
        color: "black"
    });
    game.updateSquare("b8", {
        type: "knight",
        color: "black"
    });
    game.updateSquare("c8", {
        type: "bishop",
        color: "black"
    });
    game.updateSquare("d8", {
        type: "king",
        color: "black"
    });
    game.updateSquare("e8", {
        type: "queen",
        color: "black"
    });
    game.updateSquare("f8", {
        type: "bishop",
        color: "black"
    });
    game.updateSquare("g8", {
        type: "knight",
        color: "black"
    });
    game.updateSquare("h8", {
        type: "rook",
        color: "black"
    });
    for(let i = 1; i <= 8; i++){
        const file = fileLetters.at(i - 1);
        game.updateSquare(`${file}2`, {
            type: "pawn",
            color: "white"
        });
        game.updateSquare(`${file}7`, {
            type: "pawn",
            color: "black"
        });
    }
    await game.updateBoard();
    games.set(id, game);
}
export default class Chess extends CCommand {
    name;
    description;
    options;
    subcommandFunctions;
    constructor(client){
        super(client);
        this.client = client;
        this.name = "chess";
        this.description = "Chess related commands";
        this.options = [
            {
                name: "play",
                description: "Play chess with someone",
                type: Harmony.ApplicationCommandOptionType.SUB_COMMAND,
                options: [
                    {
                        type: Harmony.ApplicationCommandOptionType.USER,
                        name: "opponent",
                        description: "Who you want to play against",
                        required: true
                    }
                ]
            }
        ];
        this.subcommandFunctions = new Map;
        this.subcommandFunctions.set("play", async (ctx)=>{
            console.log(ctx.data);
            if (!ctx.member || !ctx.data || !("options" in ctx.data)) return;
            if (!ctx.data.options[0] || !("id" in ctx.data.options[0])) return;
            //const opponent = await client.users.fetch(ctx.data.options[0].id)
            console.log(ctx.data);
            const game = games.get(ctx.member.user.id);
            if (!game) {
                await createGame(ctx.member.user.id);
                const selfFunc = this.subcommandFunctions.get("play");
                if (selfFunc) {
                    return selfFunc(ctx);
                }
            }
            if (!game) return;
            await game.updateBoard();
            ctx.respond({
                files: [
                    new Harmony.MessageAttachment("board.png", new Blob([
                        game.canvas.canvas.toBuffer()
                    ]))
                ],
                embeds: [
                    new Harmony.Embed().setTitle("Chess game").setImage("attachment://board.png")
                ],
                components: new Harmony.MessageComponents(...messageComponents)
            });
        });
    }
    async execute(ctx) {
        if (!ctx.data || !("options" in ctx.data) || !ctx.data.options[0]) return;
        const func = this.subcommandFunctions.get(ctx.data.options[0].name);
        if (!func) return;
        await func(ctx);
    }
    client;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vaG9tZS9ydW5uZXIvY2hlc3MtYm90L2NvbW1hbmRzL2NoZXNzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhcm1vbnksIENhbnZhcyB9IGZyb20gXCIuLi9kZXBzLnRzXCI7XG5pbXBvcnQgQ0NvbW1hbmQgZnJvbSBcIi4uL2NsYXNzZXMvY3VzdG9tQ29tbWFuZC50c1wiO1xuXG4vLyBUeXBlc1xuXG50eXBlIFBpZWNlVHlwZSA9IFwicGF3blwiIHwgXCJyb29rXCIgfCBcImtuaWdodFwiIHwgXCJiaXNob3BcIiB8IFwia2luZ1wiIHwgXCJxdWVlblwiXG50eXBlIFBpZWNlQ29sb3IgPSBcIndoaXRlXCIgfCBcImJsYWNrXCJcblxuLy8gSW50ZXJmYWNlc1xuXG5pbnRlcmZhY2UgUGllY2Uge1xuICAgIHR5cGU6IFBpZWNlVHlwZSxcbiAgICBjb2xvcjogUGllY2VDb2xvclxufVxuXG4vLyBDbGFzc2VzXG5cbmNsYXNzIFNxdWFyZSB7XG4gICAgcGllY2U/OiBQaWVjZVxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwdWJsaWMgeDogbnVtYmVyLFxuICAgICAgICBwdWJsaWMgeTogbnVtYmVyLFxuICAgICAgICBwdWJsaWMgcG9zaXRpb246IHN0cmluZyxcbiAgICAgICAgcHVibGljIGNvbG9yOiBQaWVjZUNvbG9yXG4gICAgKSB7XG5cbiAgICB9XG59XG5cbmNsYXNzIEJvYXJkIHtcbiAgICBjYW52YXMhOiBDYW52YXMuRW11bGF0ZWRDYW52YXMyRDtcbiAgICBjb250ZXh0ITogQ2FudmFzLkNhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc2l6ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuY2FudmFzID0gQ2FudmFzLmNyZWF0ZUNhbnZhcyhzaXplLHNpemUpO1xuICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgR2FtZSB7XG4gICAgYm9hcmQ6IE1hcDxzdHJpbmcsU3F1YXJlPiA9IG5ldyBNYXA8c3RyaW5nLFNxdWFyZT47XG4gICAgY2FudmFzITogQm9hcmQ7XG4gICAgXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuY2FudmFzID0gbmV3IEJvYXJkKDYwMCk7XG4gICAgfVxuXG4gICAgdXBkYXRlU3F1YXJlKHBvc2l0aW9uOiBzdHJpbmcscGllY2U/OiBQaWVjZSkge1xuICAgICAgICBjb25zdCBzcXVhcmUgPSB0aGlzLmJvYXJkLmdldChwb3NpdGlvbik7XG4gICAgICAgIGlmICghc3F1YXJlKSByZXR1cm47XG4gICAgICAgIHNxdWFyZS5waWVjZSA9IHBpZWNlO1xuICAgIH1cblxuICAgIG1vdmUob2xkUG9zaXRpb246IHN0cmluZyxuZXdQb3NpdGlvbjogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHNxdWFyZTEgPSB0aGlzLmJvYXJkLmdldChvbGRQb3NpdGlvbik7XG4gICAgICAgIGNvbnN0IHNxdWFyZTIgPSB0aGlzLmJvYXJkLmdldChuZXdQb3NpdGlvbik7XG5cbiAgICAgICAgaWYgKCFzcXVhcmUxIHx8ICFzcXVhcmUyKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmICghc3F1YXJlMS5waWVjZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBpZiAoc3F1YXJlMi5waWVjZSAmJiAoc3F1YXJlMS5waWVjZS5jb2xvciA9PT0gc3F1YXJlMi5waWVjZS5jb2xvcikpIHJldHVybiBmYWxzZTtcblxuICAgICAgICBzcXVhcmUyLnBpZWNlID0gc3F1YXJlMS5waWVjZTtcbiAgICAgICAgc3F1YXJlMS5waWVjZSA9IHVuZGVmaW5lZDtcblxuICAgICAgICB0aGlzLmJvYXJkLnNldChvbGRQb3NpdGlvbixzcXVhcmUxKTtcbiAgICAgICAgdGhpcy5ib2FyZC5zZXQobmV3UG9zaXRpb24sc3F1YXJlMik7XG5cbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVCb2FyZCgpIHtcbiAgICAgICAgZm9yIChjb25zdCBbX3Bvc2l0aW9uLHNxdWFyZV0gb2YgdGhpcy5ib2FyZC5lbnRyaWVzKCkpIHtcbiAgICAgICAgICAgIGlmICghc3F1YXJlLnBpZWNlKSBjb250aW51ZTtcbiAgICAgICAgICAgIGNvbnN0IGltYWdlUGF0aCA9IGBhc3NldHMvcGllY2VzLyR7c3F1YXJlLnBpZWNlLmNvbG9yfS8ke3NxdWFyZS5waWVjZS50eXBlfS5wbmdgO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbWFnZSA9IGF3YWl0IENhbnZhcy5sb2FkSW1hZ2UoaW1hZ2VQYXRoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNhbnZhcy5jb250ZXh0LmRyYXdJbWFnZShpbWFnZSxzcXVhcmUueCxzcXVhcmUueSx0aGlzLmJvYXJkLnNpemUgKyAxMCx0aGlzLmJvYXJkLnNpemUgKyAxMCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG4vLyBWYXJpYWJsZXNcblxuY29uc3QgbWVzc2FnZUNvbXBvbmVudHM6IEhhcm1vbnkuTWVzc2FnZUNvbXBvbmVudERhdGFbXSA9IFtcbiAgICB7XG4gICAgICAgIHR5cGU6IEhhcm1vbnkuTWVzc2FnZUNvbXBvbmVudFR5cGUuQUNUSU9OX1JPVyxcbiAgICAgICAgY29tcG9uZW50czogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHR5cGU6IEhhcm1vbnkuTWVzc2FnZUNvbXBvbmVudFR5cGUuQlVUVE9OLFxuICAgICAgICAgICAgICAgIHN0eWxlOiBIYXJtb255LkJ1dHRvblN0eWxlLkJMVVJQTEUsXG4gICAgICAgICAgICAgICAgbGFiZWw6IFwiTWFrZSBhIG1vdmVcIixcbiAgICAgICAgICAgICAgICBjdXN0b21JRDogXCJtYWtlTW92ZVwiXG4gICAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICB9XG5dXG5cbmNvbnN0IHByaW1hcnlDb2xvciA9IFwiI2VlZWVkNVwiOyAvLyBXaGl0ZVxuY29uc3Qgc2Vjb25kYXJ5Q29sb3IgPSBcIiM3Yzk1NWJcIjsgLy8gR3JlZW5cbmNvbnN0IGZpbGVMZXR0ZXJzID0gXCJhYmNkZWZnaFwiO1xuXG5jb25zdCBnYW1lczogTWFwPHN0cmluZyxHYW1lPiA9IG5ldyBNYXA8c3RyaW5nLEdhbWU+O1xuXG4vLyBGdW5jdGlvbnNcblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2FtZShpZDogc3RyaW5nKSB7XG4gICAgaWYgKGdhbWVzLmdldChpZCkpIHJldHVybjtcblxuICAgIGNvbnN0IGdhbWUgPSBuZXcgR2FtZSgpO1xuICAgIGNvbnN0IHNxdWFyZVNpemUgPSBnYW1lLmNhbnZhcy5zaXplIC8gODtcblxuICAgIGZvciAobGV0IHggPSAwOyB4IDwgODsgeCsrKSB7XG4gICAgICAgIGNvbnN0IGZpbGVMZXR0ZXIgPSBmaWxlTGV0dGVycy5hdCh4KTtcbiAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCA4OyB5KyspIHtcbiAgICAgICAgICAgIGNvbnN0IHNxdWFyZVBvc2l0aW9uID0gYCR7ZmlsZUxldHRlcn0keyg4IC0geSl9YFxuICAgICAgICAgICAgZ2FtZS5jYW52YXMuY29udGV4dC5maWxsU3R5bGUgPSAoKHgreSklMj09MCkgPyBwcmltYXJ5Q29sb3I6c2Vjb25kYXJ5Q29sb3I7XG4gICAgICAgICAgICBjb25zdCB4T2Zmc2V0ID0geCAqIHNxdWFyZVNpemU7XG4gICAgICAgICAgICBjb25zdCB5T2Zmc2V0ID0geSAqIHNxdWFyZVNpemU7XG4gICAgICAgICAgICBnYW1lLmNhbnZhcy5jb250ZXh0LmZpbGxSZWN0KHhPZmZzZXQseU9mZnNldCxzcXVhcmVTaXplLHNxdWFyZVNpemUpO1xuICAgICAgICAgICAgY29uc3Qgc3F1YXJlID0gbmV3IFNxdWFyZShcbiAgICAgICAgICAgICAgICB4T2Zmc2V0LFxuICAgICAgICAgICAgICAgIHlPZmZzZXQsXG4gICAgICAgICAgICAgICAgc3F1YXJlUG9zaXRpb24sXG4gICAgICAgICAgICAgICAgKCh4K3kpJTI9PTApID8gXCJ3aGl0ZVwiOlwiYmxhY2tcIlxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGdhbWUuYm9hcmQuc2V0KHNxdWFyZVBvc2l0aW9uLHNxdWFyZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgd2hpdGUgcGllY2VzXG4gICAgZ2FtZS51cGRhdGVTcXVhcmUoXG4gICAgICAgIFwiYTFcIixcbiAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogXCJyb29rXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImIxXCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwia25pZ2h0XCIsXG4gICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImMxXCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwiYmlzaG9wXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImQxXCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwia2luZ1wiLFxuICAgICAgICAgICAgY29sb3I6IFwid2hpdGVcIlxuICAgICAgICB9XG4gICAgKTtcbiAgICBnYW1lLnVwZGF0ZVNxdWFyZShcbiAgICAgICAgXCJlMVwiLFxuICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiBcInF1ZWVuXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImYxXCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwiYmlzaG9wXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImcxXCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwia25pZ2h0XCIsXG4gICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImgxXCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwicm9va1wiLFxuICAgICAgICAgICAgY29sb3I6IFwid2hpdGVcIlxuICAgICAgICB9XG4gICAgKTtcbiAgICAvLyBDcmVhdGUgYmxhY2sgcGllY2VzXG4gICAgZ2FtZS51cGRhdGVTcXVhcmUoXG4gICAgICAgIFwiYThcIixcbiAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogXCJyb29rXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImI4XCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwia25pZ2h0XCIsXG4gICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImM4XCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwiYmlzaG9wXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImQ4XCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwia2luZ1wiLFxuICAgICAgICAgICAgY29sb3I6IFwiYmxhY2tcIlxuICAgICAgICB9XG4gICAgKTtcbiAgICBnYW1lLnVwZGF0ZVNxdWFyZShcbiAgICAgICAgXCJlOFwiLFxuICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiBcInF1ZWVuXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImY4XCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwiYmlzaG9wXCIsXG4gICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImc4XCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwia25pZ2h0XCIsXG4gICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgIH1cbiAgICApO1xuICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICBcImg4XCIsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHR5cGU6IFwicm9va1wiLFxuICAgICAgICAgICAgY29sb3I6IFwiYmxhY2tcIlxuICAgICAgICB9XG4gICAgKTtcblxuICAgIGZvciAobGV0IGk9MTtpIDw9IDg7aSsrKSB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSBmaWxlTGV0dGVycy5hdChpIC0gMSk7XG4gICAgICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICAgICAgYCR7ZmlsZX0yYCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcInBhd25cIixcbiAgICAgICAgICAgICAgICBjb2xvcjogXCJ3aGl0ZVwiXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIGdhbWUudXBkYXRlU3F1YXJlKFxuICAgICAgICAgICAgYCR7ZmlsZX03YCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcInBhd25cIixcbiAgICAgICAgICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgYXdhaXQgZ2FtZS51cGRhdGVCb2FyZCgpO1xuXG4gICAgZ2FtZXMuc2V0KGlkLGdhbWUpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDaGVzcyBleHRlbmRzIENDb21tYW5kIHtcbiAgICBuYW1lID0gXCJjaGVzc1wiO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nIHwgdW5kZWZpbmVkID0gXCJDaGVzcyByZWxhdGVkIGNvbW1hbmRzXCI7XG4gICAgb3B0aW9uczogSGFybW9ueS5TbGFzaENvbW1hbmRPcHRpb25bXSA9IFtcbiAgICAgICAge1xuICAgICAgICAgICAgbmFtZTogXCJwbGF5XCIsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJQbGF5IGNoZXNzIHdpdGggc29tZW9uZVwiLFxuICAgICAgICAgICAgdHlwZTogSGFybW9ueS5BcHBsaWNhdGlvbkNvbW1hbmRPcHRpb25UeXBlLlNVQl9DT01NQU5ELFxuICAgICAgICAgICAgb3B0aW9uczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogSGFybW9ueS5BcHBsaWNhdGlvbkNvbW1hbmRPcHRpb25UeXBlLlVTRVIsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwib3Bwb25lbnRcIixcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiV2hvIHlvdSB3YW50IHRvIHBsYXkgYWdhaW5zdFwiLFxuICAgICAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgIF1cblxuICAgIHN1YmNvbW1hbmRGdW5jdGlvbnM6IE1hcDxzdHJpbmcsKGN0eDogSGFybW9ueS5JbnRlcmFjdGlvbikgPT4gUHJvbWlzZTx2b2lkPj4gPSBuZXcgTWFwPHN0cmluZywoY3R4OiBIYXJtb255LkludGVyYWN0aW9uKSA9PiBQcm9taXNlPHZvaWQ+PjtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgY2xpZW50OiBIYXJtb255LkNsaWVudCkge1xuICAgICAgICBzdXBlcihjbGllbnQpO1xuICAgICAgICB0aGlzLnN1YmNvbW1hbmRGdW5jdGlvbnMuc2V0KFxuICAgICAgICAgICAgXCJwbGF5XCIsXG4gICAgICAgICAgICBhc3luYyAoY3R4OiBIYXJtb255LkludGVyYWN0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coY3R4LmRhdGEpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFjdHgubWVtYmVyIHx8ICFjdHguZGF0YSB8fCAhKFwib3B0aW9uc1wiIGluIGN0eC5kYXRhKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICghY3R4LmRhdGEub3B0aW9uc1swXSB8fCAhKFwiaWRcIiBpbiBjdHguZGF0YS5vcHRpb25zWzBdKSkgcmV0dXJuO1xuICAgIFxuICAgICAgICAgICAgICAgIC8vY29uc3Qgb3Bwb25lbnQgPSBhd2FpdCBjbGllbnQudXNlcnMuZmV0Y2goY3R4LmRhdGEub3B0aW9uc1swXS5pZClcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjdHguZGF0YSlcbiAgICAgICAgICAgICAgICBjb25zdCBnYW1lID0gZ2FtZXMuZ2V0KGN0eC5tZW1iZXIudXNlci5pZCk7XG4gICAgICAgICAgICAgICAgaWYgKCFnYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNyZWF0ZUdhbWUoY3R4Lm1lbWJlci51c2VyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZkZ1bmMgPSB0aGlzLnN1YmNvbW1hbmRGdW5jdGlvbnMuZ2V0KFwicGxheVwiKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGZGdW5jKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZkZ1bmMoY3R4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWdhbWUpIHJldHVybjtcbiAgICAgICAgICAgICAgICBhd2FpdCBnYW1lLnVwZGF0ZUJvYXJkKCk7XG4gICAgICAgICAgICAgICAgY3R4LnJlc3BvbmQoe1xuICAgICAgICAgICAgICAgICAgICBmaWxlczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IEhhcm1vbnkuTWVzc2FnZUF0dGFjaG1lbnQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJib2FyZC5wbmdcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgQmxvYihbZ2FtZS5jYW52YXMuY2FudmFzLnRvQnVmZmVyKCldKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBlbWJlZHM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBIYXJtb255LkVtYmVkKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2V0VGl0bGUoXCJDaGVzcyBnYW1lXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNldEltYWdlKFwiYXR0YWNobWVudDovL2JvYXJkLnBuZ1wiKVxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRzOiBuZXcgSGFybW9ueS5NZXNzYWdlQ29tcG9uZW50cyguLi5tZXNzYWdlQ29tcG9uZW50cylcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlKGN0eDogSGFybW9ueS5JbnRlcmFjdGlvbikge1xuICAgICAgICBpZiAoIWN0eC5kYXRhIHx8ICEoXCJvcHRpb25zXCIgaW4gY3R4LmRhdGEpIHx8ICFjdHguZGF0YS5vcHRpb25zWzBdKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgZnVuYyA9IHRoaXMuc3ViY29tbWFuZEZ1bmN0aW9ucy5nZXQoY3R4LmRhdGEub3B0aW9uc1swXS5uYW1lKTtcblxuICAgICAgICBpZiAoIWZ1bmMpIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IGZ1bmMoY3R4KTtcbiAgICB9XG59Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsT0FBTyxFQUFFLE1BQU0sUUFBUSxhQUFhO0FBQzdDLE9BQU8sY0FBYyw4QkFBOEI7QUFjbkQsVUFBVTtBQUVWLE1BQU07SUFDRixNQUFhO0lBQ2IsWUFDVyxHQUNBLEdBQ0EsVUFDQSxNQUNUO2lCQUpTO2lCQUNBO3dCQUNBO3FCQUNBO0lBR1g7SUFOVztJQUNBO0lBQ0E7SUFDQTtBQUlmO0FBRUEsTUFBTTtJQUNGLE9BQWlDO0lBQ2pDLFFBQTBDO0lBQzFDLFlBQW1CLEtBQWM7b0JBQWQ7UUFDZixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sWUFBWSxDQUFDLE1BQUs7UUFDdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztJQUMxQztJQUhtQjtBQUl2QjtBQUVBLE9BQU8sTUFBTTtJQUNULFFBQTRCLElBQUksSUFBbUI7SUFDbkQsT0FBZTtJQUVmLGFBQWM7UUFDVixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksTUFBTTtJQUM1QjtJQUVBLGFBQWEsUUFBZ0IsRUFBQyxLQUFhLEVBQUU7UUFDekMsTUFBTSxTQUFTLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO1FBQzlCLElBQUksQ0FBQyxRQUFRO1FBQ2IsT0FBTyxLQUFLLEdBQUc7SUFDbkI7SUFFQSxLQUFLLFdBQW1CLEVBQUMsV0FBbUIsRUFBRTtRQUMxQyxNQUFNLFVBQVUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7UUFDL0IsTUFBTSxVQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO1FBRS9CLElBQUksQ0FBQyxX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